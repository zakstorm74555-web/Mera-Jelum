<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#004D40">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Ù…ÛŒØ±Ø§ Ø¬ÛÙ„Ù…">
<link rel="apple-touch-icon" href="icon.png">
    <title>Ù…ÛŒØ±Ø§ Ø¬ÛÙ„Ù… - Ø¯Ú©Ø§Ù†ÛŒÚº</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #004D40; --accent: #D4AF37; }
        body { margin: 0; background: #f4f4f4; font-family: 'Segoe UI'; padding-bottom: 80px; }
        .header { background: var(--primary); color: var(--accent); padding: 15px; text-align: center; font-size: 20px; font-weight: bold; position: sticky; top: 0; z-index: 100; }
        
        /* Shop Card Styling */
        .shop-card { background: white; margin: 15px; border-radius: 20px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .shop-img { width: 100%; height: 180px; object-fit: cover; }
        .shop-info { padding: 15px; }
        .shop-name { font-size: 1.2rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        
        .rating-box { display: flex; align-items: center; gap: 5px; color: #ff9800; font-weight: bold; margin-bottom: 10px; }
        .give-rate-btn { background: #fff; color: var(--primary); border: 1px solid var(--primary); padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: 0.3s; }
        .give-rate-btn:hover { background: var(--primary); color: white; }
        
        .map-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 10px; float: left; cursor: pointer; text-decoration: none; font-size: 14px; }

        /* Modal (Popup) Styling */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; }
        .star-rating { font-size: 30px; cursor: pointer; color: #ccc; transition: 0.2s; }
        .star-rating.selected { color: #ff9800; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .nav-item { text-decoration: none; color: #666; font-size: 14px; text-align: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">ğŸ›ï¸ Ø¬ÛÙ„Ù… Ú©ÛŒ Ø¯Ú©Ø§Ù†ÛŒÚº</div>

    <div id="shops-list">
        <p style="text-align: center; margin-top: 20px;">Ø¯Ú©Ø§Ù†ÛŒÚº Ù„ÙˆÚˆ ÛÙˆ Ø±ÛÛŒ ÛÛŒÚº...</p>
    </div>

    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <h3>Ø¯Ú©Ø§Ù† Ú©Ùˆ Ø±ÛŒÙ¹ Ú©Ø±ÛŒÚº â­</h3>
            <div id="stars-container">
                <span class="star-rating" onclick="setRating(1)">â˜…</span>
                <span class="star-rating" onclick="setRating(2)">â˜…</span>
                <span class="star-rating" onclick="setRating(3)">â˜…</span>
                <span class="star-rating" onclick="setRating(4)">â˜…</span>
                <span class="star-rating" onclick="setRating(5)">â˜…</span>
            </div>
            <br>
            <button class="give-rate-btn" style="width: 100%; padding: 10px;" onclick="submitRating()">Ø±ÛŒÙ¹Ù†Ú¯ Ø¨Ú¾ÛŒØ¬ÛŒÚº</button>
            <p style="font-size: 12px; color: red; cursor: pointer; margin-top: 10px;" onclick="closeModal()">Ø¨Ù†Ø¯ Ú©Ø±ÛŒÚº</p>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="home.html" class="nav-item">ğŸ <br>ÛÙˆÙ…</a>
        <a href="shops.html" class="nav-item active">ğŸ›’<br>Ø¯Ú©Ø§Ù†ÛŒÚº</a>
        <a href="profile.html" class="nav-item">ğŸ‘¤<br>Ù¾Ø±ÙˆÙØ§Ø¦Ù„</a>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDey-KaC_Ty-dqijuQMWeQjtUx3eaaXc6k",
            authDomain: "mera-jehlum.firebaseapp.com",
            databaseURL: "https://mera-jehlum-default-rtdb.firebaseio.com",
            projectId: "mera-jehlum",
            storageBucket: "mera-jehlum.firebasestorage.app",
            messagingSenderId: "1093409222171",
            appId: "1:1093409222171:web:e9c1d2113c6bb7ae2952be",
            measurementId: "G-VLPHNJKZ8P"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentShopId = "";
        let selectedRatingValue = 0;

        // Load Shops
        db.ref('shops').on('value', (snapshot) => {
            const list = document.getElementById('shops-list');
            list.innerHTML = "";
            snapshot.forEach((child) => {
                const data = child.val();
                const shopId = child.key;
                
                // Calculate average rating
                let avg = 5.0;
                let count = 0;
                if(data.ratings) {
                    const rValues = Object.values(data.ratings);
                    count = rValues.length;
                    avg = (rValues.reduce((a, b) => a + b, 0) / count).toFixed(1);
                }

                list.innerHTML += `
                    <div class="shop-card">
                        <img src="${data.image_url || 'placeholder.jpg'}" class="shop-img">
                        <div class="shop-info">
                            <div class="shop-name">${data.shop_name}</div>
                            <div class="rating-box">
                                â­ ${avg} <small style="color: grey;">(${count} Ø±ÛŒÙ¹Ù†Ú¯Ø²)</small>
                                <button class="give-rate-btn" onclick="openRatingModal('${shopId}')">Ø±ÛŒÙ¹ Ø¯ÛŒÚº</button>
                            </div>
                            <a href="${data.map_link || '#'}" target="_blank" class="map-btn">Ù†Ù‚Ø´Û Ø¯ÛŒÚ©Ú¾ÛŒÚº</a>
                        </div>
                    </div>`;
            });
        });

        // Rating Logic
        function openRatingModal(id) {
            currentShopId = id;
            selectedRatingValue = 0;
            resetStars();
            document.getElementById('ratingModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('ratingModal').style.display = 'none';
        }

        function setRating(val) {
            selectedRatingValue = val;
            resetStars();
            const stars = document.getElementsByClassName('star-rating');
            for(let i=0; i<val; i++) {
                stars[i].classList.add('selected');
            }
        }

        function resetStars() {
            const stars = document.getElementsByClassName('star-rating');
            for(let s of stars) s.classList.remove('selected');
        }

        function submitRating() {
            if(selectedRatingValue === 0) return alert("Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø³ØªØ§Ø±Û’ Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº!");
            
            db.ref('shops/' + currentShopId + '/ratings').push(selectedRatingValue)
            .then(() => {
                alert("Ø´Ú©Ø±ÛŒÛ! Ø¢Ù¾ Ú©ÛŒ Ø±ÛŒÙ¹Ù†Ú¯ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯Ø¦ÛŒÛ”");
                closeModal();
            });
        }
    </script>
</body>
</html>
